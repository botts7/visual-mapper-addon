<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="0.4.0-beta.3.17" data-build="dynamic">
    <title>Diagnostics - Visual Mapper</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- Dynamic CSS loading -->
    <script>
        const cacheKey = sessionStorage.getItem('vmCacheKey') || Date.now();
        sessionStorage.setItem('vmCacheKey', cacheKey);
        document.write('<link rel="stylesheet" href="css/styles.css?v=0.4.0-beta.3.19">');
    </script>
    <noscript>
        <link rel="stylesheet" href="css/styles.css">
    </noscript>

    <!-- Apply dark mode immediately to prevent flash -->
    <script>
        (function() {
            const theme = localStorage.getItem('visual-mapper-theme');
            if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-mode');
                document.addEventListener('DOMContentLoaded', () => {
                    document.body.classList.add('dark-mode');
                });
            }
        })();
    </script>
    <style>
        /* Tab Navigation */
        .diag-tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
            background: var(--card-background);
            border-radius: 8px 8px 0 0;
        }
        .diag-tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }
        .diag-tab:hover {
            color: var(--text-color);
            background: var(--background-color);
        }
        .diag-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-panel {
            display: none;
        }
        .tab-panel.active {
            display: block;
        }
        /* Section styling */
        .section-card {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }
        .section-card h3 {
            margin: 0 0 12px 0;
            font-size: 15px;
            color: var(--text-color);
        }
        .section-desc {
            color: var(--text-secondary);
            font-size: 13px;
            margin-bottom: 12px;
        }
        /* Benchmark cards */
        .benchmark-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        .benchmark-card {
            background: var(--background-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        .benchmark-card h4 {
            margin: 0 0 8px 0;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .benchmark-value {
            font-size: 22px;
            font-weight: bold;
        }
        .benchmark-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        /* Pipeline steps */
        .pipeline-step {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pipeline-step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .remove-step-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Device selector */
        .device-select-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        .device-select-row select {
            min-width: 200px;
            padding: 8px;
        }
        /* Results area */
        .result-area {
            margin-top: 12px;
            padding: 10px;
            background: var(--background-color);
            border-radius: 6px;
            min-height: 40px;
        }
        /* Two column layout for testing */
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
        }
        @media (max-width: 768px) {
            .diag-tab {
                padding: 10px 14px;
                font-size: 12px;
            }
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar injected by js/components/navbar.js -->
    <nav></nav>
    <script type="module" src="js/init.js?v=0.4.0-beta.3.19"></script>
    <div class="container">
        <!-- Page Header -->
        <div class="card" style="margin-bottom: 0;">
            <h1 style="margin: 0;">System Diagnostics</h1>
            <p style="margin: 5px 0 0 0; color: var(--text-secondary);">Test backend capabilities, benchmarks, and system health</p>
        </div>

        <!-- Tab Navigation -->
        <div class="diag-tabs">
            <button class="diag-tab active" data-tab="health">Health</button>
            <button class="diag-tab" data-tab="benchmarks">Benchmarks</button>
            <button class="diag-tab" data-tab="maintenance">Maintenance</button>
            <button class="diag-tab" data-tab="testing">Testing</button>
            <button class="diag-tab" data-tab="flows">Flows</button>
            <button class="diag-tab" data-tab="logs">Logs</button>
        </div>

        <!-- TAB: Health -->
        <div id="tab-health" class="tab-panel active">
            <div class="test-grid">
                <div class="section-card">
                    <h3>API Health</h3>
                    <button id="testHealth" class="btn btn-primary">Test API Health</button>
                    <div id="healthResult" class="result-area"></div>
                </div>

                <div class="section-card">
                    <h3>ADB Connection</h3>
                    <button id="testAdb" class="btn btn-primary">Test ADB Devices</button>
                    <div id="adbResult" class="result-area"></div>
                </div>

                <div class="section-card">
                    <h3>MQTT Status</h3>
                    <button id="testMqtt" class="btn btn-primary">Test MQTT</button>
                    <div id="mqttResult" class="result-area"></div>
                </div>

                <div class="section-card">
                    <h3>System Status</h3>
                    <p class="section-desc">Server resource usage and health</p>
                    <button id="testSystem" class="btn btn-primary">Check System</button>
                    <div id="systemResult" class="result-area"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Benchmarks -->
        <div id="tab-benchmarks" class="tab-panel">
            <div class="section-card">
                <h3>ADB Performance Benchmark</h3>
                <p class="section-desc">Run performance tests to diagnose ADB speed issues</p>
                <div class="device-select-row">
                    <select id="benchDev" class="form-select"></select>
                    <button id="runBenchmark" class="btn btn-primary">Run Full Benchmark</button>
                    <button id="runQuickBenchmark" class="btn btn-secondary">Quick Test</button>
                </div>
                <div id="benchmarkResult"></div>
                <div id="benchmarkGrid" style="display:none;">
                    <div class="benchmark-grid">
                        <div class="benchmark-card">
                            <h4>Screenshot Capture</h4>
                            <div class="benchmark-value" id="scrAvgTime">--</div>
                            <div class="benchmark-label">avg capture time</div>
                            <div style="margin-top:6px;font-size:12px;">
                                Min: <span id="scrMinTime">--</span> | Max: <span id="scrMaxTime">--</span>
                            </div>
                        </div>
                        <div class="benchmark-card">
                            <h4>UI Hierarchy Dump</h4>
                            <div class="benchmark-value" id="uiDumpTime">--</div>
                            <div class="benchmark-label">dump time</div>
                        </div>
                        <div class="benchmark-card">
                            <h4>Connection</h4>
                            <div class="benchmark-value" id="connType">--</div>
                            <div class="benchmark-label">ADB: <span id="adbVersion">--</span></div>
                        </div>
                        <div class="benchmark-card">
                            <h4>Performance Rating</h4>
                            <div class="benchmark-value" id="perfRating">--</div>
                            <div class="benchmark-label" id="perfAdvice">Run benchmark</div>
                        </div>
                    </div>
                    <div style="margin-top:12px;background:var(--background-color);padding:12px;border-radius:8px;">
                        <h4 style="margin:0 0 8px 0;font-size:11px;color:var(--text-secondary);text-transform:uppercase;">Sample Times (ms)</h4>
                        <div id="sampleTimesChart" style="display:flex;align-items:flex-end;height:60px;gap:6px;"></div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>Capture Backend Comparison</h3>
                <p class="section-desc">Compare capture speeds between backends (adbutils vs adb_bridge)</p>
                <div class="device-select-row">
                    <select id="backendBenchDev" class="form-select"></select>
                    <button id="runBackendBenchmark" class="btn btn-primary">Run Comparison</button>
                </div>
                <div id="backendBenchResult"></div>
                <div id="backendGrid" style="display:none;">
                    <div class="benchmark-grid">
                        <div class="benchmark-card" id="adbutils-card">
                            <h4>adbutils (Modern)</h4>
                            <div class="benchmark-value" id="adbutils-avg">--</div>
                            <div class="benchmark-label">avg capture</div>
                            <div style="margin-top:6px;font-size:11px;" id="adbutils-range">Min: -- | Max: --</div>
                        </div>
                        <div class="benchmark-card" id="adb-bridge-card">
                            <h4>adb_bridge (Subprocess)</h4>
                            <div class="benchmark-value" id="adb-bridge-avg">--</div>
                            <div class="benchmark-label">avg capture</div>
                            <div style="margin-top:6px;font-size:11px;" id="adb-bridge-range">Min: -- | Max: --</div>
                        </div>
                        <div class="benchmark-card" style="border:2px solid var(--primary-color);">
                            <h4>Recommended</h4>
                            <div class="benchmark-value" style="color:var(--primary-color);" id="recommended-backend">--</div>
                            <div class="benchmark-label" id="best-time">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section-card">
                <h3>Persistent Shell Pool</h3>
                <p class="section-desc">Compare shell sessions vs regular ADB calls (50-70% faster)</p>
                <div class="device-select-row">
                    <select id="shellDev" class="form-select"></select>
                    <input type="number" id="shellIterations" value="10" min="1" max="50" style="width:70px;padding:8px;" title="Iterations">
                    <button id="runShellBenchmark" class="btn btn-primary">Run Benchmark</button>
                    <button id="getShellStats" class="btn btn-secondary">Pool Stats</button>
                </div>
                <div id="shellBenchmarkResult" class="result-area"></div>
            </div>

            <div class="section-card" id="backendSettingsCard">
                <h3>Backend Settings</h3>
                <p class="section-desc">Override auto-detected backends based on benchmark results</p>
                <div class="device-select-row">
                    <select id="backendSettingsDev" class="form-select"></select>
                    <button id="loadBackendSettings" class="btn btn-secondary">Load Settings</button>
                </div>
                <div id="backendSettingsGrid" style="display:none; margin-top:15px;">
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px;">
                        <div class="benchmark-card">
                            <h4>Capture Backend</h4>
                            <select id="captureBackendSelect" class="form-select" style="margin-top:8px;">
                                <option value="auto">Auto (recommended)</option>
                                <option value="adbutils">adbutils (Python)</option>
                                <option value="subprocess">subprocess (adb_bridge)</option>
                            </select>
                            <div class="benchmark-label" style="margin-top:6px;">Used for screenshots</div>
                        </div>
                        <div class="benchmark-card">
                            <h4>Shell Method</h4>
                            <select id="shellMethodSelect" class="form-select" style="margin-top:8px;">
                                <option value="auto">Auto (persistent)</option>
                                <option value="persistent">Persistent Shell</option>
                                <option value="regular">Regular ADB</option>
                            </select>
                            <div class="benchmark-label" style="margin-top:6px;">Used for commands</div>
                        </div>
                    </div>
                    <div style="margin-top:15px;">
                        <button id="saveBackendSettings" class="btn btn-primary">Save Settings</button>
                        <span id="backendSaveStatus" style="margin-left:10px;"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: Maintenance -->
        <div id="tab-maintenance" class="tab-panel">
            <div class="section-card">
                <h3>ADB Server Controls</h3>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button id="restartAdbServer" class="btn btn-primary">Restart ADB Server</button>
                    <button id="checkServerStatus" class="btn btn-secondary">Check Status</button>
                </div>
                <div id="serverStatusResult" class="result-area"></div>
            </div>

            <div class="section-card">
                <h3>Device Maintenance</h3>
                <div class="device-select-row">
                    <select id="maintDev" class="form-select"></select>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;">
                    <button id="trimCache" class="btn btn-secondary">Trim Cache</button>
                    <button id="optimizeUi" class="btn btn-secondary">Optimize UI</button>
                    <button id="resetUi" class="btn btn-secondary">Reset UI</button>
                    <button id="fullOptimize" class="btn btn-primary">Full Optimize</button>
                </div>
                <div id="maintResult" class="result-area"></div>
            </div>

            <div class="section-card">
                <h3>Connection Metrics</h3>
                <button id="getConnMetrics" class="btn btn-secondary">Get Metrics</button>
                <div id="metricsResult" class="result-area"></div>
            </div>

            <details class="section-card" style="padding:0;">
                <summary style="padding:15px;cursor:pointer;font-weight:600;">Advanced Options</summary>
                <div style="padding:0 15px 15px 15px;">
                    <div style="margin-bottom:15px;">
                        <label style="font-size:13px;color:var(--text-secondary);">ART Compilation (5-15 min):</label>
                        <div style="display:flex;gap:10px;margin-top:5px;">
                            <select id="compileMode" class="form-select" style="width:auto;">
                                <option value="speed-profile">speed-profile</option>
                                <option value="speed">speed (Max)</option>
                                <option value="verify">verify (Minimal)</option>
                            </select>
                            <button id="compileApps" class="btn btn-secondary">Compile</button>
                        </div>
                    </div>
                    <div style="margin-bottom:15px;">
                        <label style="font-size:13px;color:var(--text-secondary);">Background Process Limit:</label>
                        <div style="display:flex;gap:10px;margin-top:5px;">
                            <select id="bgLimit" class="form-select" style="width:auto;">
                                <option value="-1">Default</option>
                                <option value="4">4 (Standard)</option>
                                <option value="2">2 (Aggressive)</option>
                                <option value="0">0 (None)</option>
                            </select>
                            <button id="setBgLimit" class="btn btn-secondary">Apply</button>
                        </div>
                    </div>
                    <div>
                        <label style="font-size:13px;color:var(--text-secondary);">Emergency Reset:</label>
                        <div style="margin-top:5px;">
                            <button id="resetDisplay" class="btn" style="background:#dc3545;color:white;">Reset Display</button>
                        </div>
                    </div>
                </div>
            </details>
        </div>

        <!-- TAB: Testing -->
        <div id="tab-testing" class="tab-panel">
            <div class="test-grid">
                <div class="section-card">
                    <h3>Screenshot Test</h3>
                    <div class="device-select-row">
                        <select id="scrDev" class="form-select"></select>
                        <button id="testScr" class="btn btn-primary">Capture</button>
                    </div>
                    <div id="scrResult" class="result-area"></div>
                </div>

                <div class="section-card">
                    <h3>Device Control Test</h3>
                    <div class="device-select-row">
                        <select id="ctrlDev" class="form-select"></select>
                    </div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button id="testTap" class="btn btn-secondary">Tap (500,500)</button>
                        <button id="testKey" class="btn btn-secondary">HOME Key</button>
                        <button id="testSwipe" class="btn btn-secondary">Swipe Down</button>
                    </div>
                    <div id="ctrlResult" class="result-area"></div>
                </div>
            </div>

            <div class="section-card">
                <h3>Text Extraction Test</h3>
                <p class="section-desc">Test single or multi-step extraction pipelines</p>
                <div style="margin-bottom:10px;">
                    <label style="font-size:13px;">Text to extract from:</label>
                    <input id="extText" class="form-input" value="Updated: 22/12/25 5:29 pm" style="width:100%;margin-top:5px;padding:8px;">
                </div>
                <div id="pipelineSteps"></div>
                <button id="addStep" class="btn btn-secondary" style="margin-bottom:10px;">+ Add Step</button>
                <div style="border-top:1px solid var(--border-color);padding-top:10px;margin-top:5px;">
                    <label style="font-size:13px;font-weight:500;">Post-Processing:</label>
                    <div style="display:flex;gap:15px;margin:8px 0;flex-wrap:wrap;">
                        <label style="font-size:13px;"><input type="checkbox" id="extractNumeric"> Numeric only</label>
                        <label style="font-size:13px;"><input type="checkbox" id="removeUnit"> Remove unit</label>
                    </div>
                    <div style="margin-top:8px;">
                        <label style="font-size:13px;">Fallback:</label>
                        <input id="fallbackValue" class="form-input" placeholder="Optional" style="width:150px;margin-left:8px;padding:6px;">
                    </div>
                </div>
                <button id="testExt" class="btn btn-primary" style="margin-top:12px;">Test Extraction</button>
                <div id="extResult" class="result-area"></div>
            </div>
        </div>

        <!-- TAB: Flows -->
        <div id="tab-flows" class="tab-panel">
            <div class="test-grid">
                <div class="section-card">
                    <h3>Flow Scheduler</h3>
                    <p class="section-desc">Test scheduler status and controls</p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button id="testSchedulerStatus" class="btn btn-primary">Get Status</button>
                        <button id="testSchedulerPause" class="btn btn-secondary">Pause</button>
                        <button id="testSchedulerResume" class="btn btn-secondary">Resume</button>
                    </div>
                    <div id="schedulerResult" class="result-area"></div>
                </div>

                <div class="section-card">
                    <h3>Flow API</h3>
                    <p class="section-desc">Test flow CRUD operations</p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                        <button id="testListFlows" class="btn btn-primary">List Flows</button>
                        <button id="testFlowQueue" class="btn btn-secondary">Get Queue</button>
                    </div>
                    <div class="device-select-row">
                        <select id="flowDev" class="form-select"></select>
                    </div>
                    <div id="flowResult" class="result-area"></div>
                </div>
            </div>
        </div>

        <!-- TAB: Logs -->
        <div id="tab-logs" class="tab-panel">
            <div class="section-card">
                <h3>Real-Time Logs</h3>
                <p class="section-desc">Live server log stream via WebSocket</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
                    <button id="connectLogs" class="btn btn-primary">Connect</button>
                    <button id="disconnectLogs" class="btn btn-secondary" disabled>Disconnect</button>
                    <button id="clearLogs" class="btn btn-secondary">Clear</button>
                    <select id="logLevel" class="form-select" style="width:110px;">
                        <option value="all">All</option>
                        <option value="ERROR">Errors</option>
                        <option value="WARNING">Warnings+</option>
                        <option value="INFO" selected>Info+</option>
                        <option value="DEBUG">Debug+</option>
                    </select>
                    <span id="logStatus" style="color:var(--text-secondary);font-size:12px;">Disconnected</span>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px;">
                    <div style="display:flex;gap:8px;font-size:12px;background:var(--background-color);padding:4px 8px;border-radius:4px;">
                        <label><input type="checkbox" id="expDebug"> DEBUG</label>
                        <label><input type="checkbox" id="expInfo" checked> INFO</label>
                        <label><input type="checkbox" id="expWarning" checked> WARN</label>
                        <label><input type="checkbox" id="expError" checked> ERROR</label>
                    </div>
                    <button id="copyLogs" class="btn btn-secondary btn-sm">Copy</button>
                    <button id="exportLogsJson" class="btn btn-secondary btn-sm">JSON</button>
                    <button id="exportLogsTxt" class="btn btn-secondary btn-sm">TXT</button>
                    <span style="font-size:12px;color:var(--text-secondary);"><span id="logCount">0</span> logs</span>
                </div>
                <div id="logViewer" style="background:#1a1a2e;border-radius:8px;padding:10px;height:400px;overflow-y:auto;font-family:'Consolas','Monaco',monospace;font-size:12px;line-height:1.4;">
                    <div style="color:#666;">Click "Connect" to view logs...</div>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        // Dynamic import with session-based cache busting
        const cacheKey = sessionStorage.getItem('vmCacheKey') || Date.now();
        const { default: APIClient } = await import(`./js/modules/api-client.js?v=${cacheKey}`);

        const api = new APIClient();

        // === Tab Navigation ===
        document.querySelectorAll('.diag-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                document.querySelectorAll('.diag-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.getElementById(`tab-${tabId}`).classList.add('active');
                localStorage.setItem('diag_active_tab', tabId);
            });
        });

        // Restore last active tab
        const savedTab = localStorage.getItem('diag_active_tab');
        if (savedTab) {
            const tabBtn = document.querySelector(`.diag-tab[data-tab="${savedTab}"]`);
            if (tabBtn) tabBtn.click();
        }

        // Pipeline state
        let pipelineSteps = [];

        // Load devices into dropdowns
        async function loadDevs() {
            try {
                const r = await api.get('/adb/devices');
                ['scrDev', 'ctrlDev', 'benchDev', 'backendBenchDev', 'maintDev', 'shellDev', 'flowDev', 'backendSettingsDev'].forEach(id => {
                    const s = document.getElementById(id);
                    if (!s) return;
                    s.innerHTML = '<option value="">Select device...</option>';
                    r.devices.forEach(d => {
                        s.innerHTML += `<option value="${d.id}">${d.id}</option>`;
                    });
                });
            } catch (e) {
                console.error('[Diagnostic] Failed to load devices:', e);
            }
        }


        // === ADB Benchmark Functions ===
        async function runBenchmark(quick = false) {
            const el = document.getElementById('benchmarkResult');
            const grid = document.getElementById('benchmarkGrid');
            const dev = document.getElementById('benchDev').value;

            if (!dev) {
                el.innerHTML = '<p class="status error">Please select a device first</p>';
                grid.style.display = 'none';
                return;
            }

            el.innerHTML = '<p class="status"><span class="loading-spinner"></span> Running benchmark... (this may take 10-15 seconds)</p>';
            grid.style.display = 'none';

            try {
                const samples = quick ? 1 : 5;
                const r = await api.get(`/diagnostics/adb/${dev}?samples=${samples}`);

                if (r.error) {
                    el.innerHTML = `<p class="status error">Error: ${r.error}</p>`;
                    return;
                }

                // Show success message
                el.innerHTML = '<p class="status success">Benchmark complete!</p>';

                // Display results in grid
                displayBenchmarkResults(r);
                grid.style.display = 'block';

            } catch (e) {
                el.innerHTML = `<p class="status error">Benchmark failed: ${e.message}</p>`;
                grid.style.display = 'none';
            }
        }

        function displayBenchmarkResults(data) {
            const bench = data.screenshot_benchmark;

            // Screenshot timing
            document.getElementById('scrAvgTime').textContent = `${bench.avg_ms.toFixed(0)}ms`;
            document.getElementById('scrMinTime').textContent = `${bench.min_ms.toFixed(0)}ms`;
            document.getElementById('scrMaxTime').textContent = `${bench.max_ms.toFixed(0)}ms`;

            // Set color based on performance
            const avgEl = document.getElementById('scrAvgTime');
            if (bench.avg_ms < 300) {
                avgEl.style.color = '#4caf50'; // Green - great
            } else if (bench.avg_ms < 800) {
                avgEl.style.color = '#ff9800'; // Orange - ok
            } else {
                avgEl.style.color = '#f44336'; // Red - slow
            }

            // UI Dump timing
            if (data.ui_dump_timing) {
                document.getElementById('uiDumpTime').textContent = `${data.ui_dump_timing.time_ms.toFixed(0)}ms`;
            } else {
                document.getElementById('uiDumpTime').textContent = 'N/A';
            }

            // Connection type
            const connType = data.connection_type || 'Unknown';
            const connEl = document.getElementById('connType');
            connEl.textContent = connType.toUpperCase();
            connEl.style.color = connType === 'usb' ? '#4caf50' : '#ff9800';

            // ADB version
            document.getElementById('adbVersion').textContent = data.adb_version || 'Unknown';

            // Performance rating
            const rating = calculatePerformanceRating(bench.avg_ms, connType);
            const ratingEl = document.getElementById('perfRating');
            const adviceEl = document.getElementById('perfAdvice');

            ratingEl.textContent = rating.label;
            ratingEl.style.color = rating.color;
            adviceEl.textContent = rating.advice;

            // Render sample times chart
            renderSampleChart(bench.samples_ms);
        }

        function calculatePerformanceRating(avgMs, connType) {
            if (avgMs < 200) {
                return {
                    label: 'Excellent',
                    color: '#4caf50',
                    advice: 'USB connection performing optimally'
                };
            } else if (avgMs < 400) {
                return {
                    label: 'Good',
                    color: '#8bc34a',
                    advice: 'Good performance for most use cases'
                };
            } else if (avgMs < 800) {
                return {
                    label: 'Fair',
                    color: '#ff9800',
                    advice: connType === 'wifi' ? 'WiFi latency is typical; consider USB for better FPS' : 'Some latency detected'
                };
            } else if (avgMs < 1500) {
                return {
                    label: 'Slow',
                    color: '#ff5722',
                    advice: 'High latency - streaming will be ~1 FPS. Try USB or check network.'
                };
            } else {
                return {
                    label: 'Very Slow',
                    color: '#f44336',
                    advice: 'Critical latency issues. Check ADB connection and restart ADB server.'
                };
            }
        }

        function renderSampleChart(samples) {
            const container = document.getElementById('sampleTimesChart');
            if (!samples || samples.length === 0) {
                container.innerHTML = '<span style="color:var(--text-secondary)">No sample data</span>';
                return;
            }

            const maxMs = Math.max(...samples);
            let html = '';

            samples.forEach((ms, i) => {
                const height = Math.max(10, (ms / maxMs) * 70); // 10-70px height
                let color = '#4caf50';
                if (ms > 1000) color = '#f44336';
                else if (ms > 500) color = '#ff9800';

                html += `
                    <div style="display:flex;flex-direction:column;align-items:center;flex:1;">
                        <div style="font-size:10px;color:var(--text-secondary);margin-bottom:4px;">${ms.toFixed(0)}</div>
                        <div style="width:100%;max-width:40px;height:${height}px;background:${color};border-radius:4px 4px 0 0;"></div>
                        <div style="font-size:10px;color:var(--text-secondary);margin-top:4px;">#${i + 1}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Benchmark button handlers
        document.getElementById('runBenchmark').onclick = () => runBenchmark(false);
        document.getElementById('runQuickBenchmark').onclick = () => runBenchmark(true);

        // === Backend Benchmark Functions ===
        async function runBackendBenchmark() {
            const el = document.getElementById('backendBenchResult');
            const grid = document.getElementById('backendGrid');
            const dev = document.getElementById('backendBenchDev').value;

            if (!dev) {
                el.innerHTML = '<p class="status error">Please select a device first</p>';
                grid.style.display = 'none';
                return;
            }

            el.innerHTML = '<p class="status"><span class="loading-spinner"></span> Running backend comparison... (5 samples each)</p>';
            grid.style.display = 'none';

            try {
                const r = await api.get(`/diagnostics/benchmark/${dev}?iterations=5`);

                if (r.error) {
                    el.innerHTML = `<p class="status error">Error: ${r.error}</p>`;
                    return;
                }

                el.innerHTML = '<p class="status success">Backend comparison complete!</p>';
                displayBackendResults(r);
                grid.style.display = 'block';

            } catch (e) {
                el.innerHTML = `<p class="status error">Benchmark failed: ${e.message}</p>`;
                grid.style.display = 'none';
            }
        }

        function displayBackendResults(data) {
            const backends = data.backends || {};

            // adbutils results
            const adbutils = backends.adbutils || {};
            const adbUtilsCard = document.getElementById('adbutils-card');
            if (adbutils.available && adbutils.avg_ms) {
                document.getElementById('adbutils-avg').textContent = `${adbutils.avg_ms.toFixed(0)}ms`;
                document.getElementById('adbutils-avg').style.color = getTimeColor(adbutils.avg_ms);
                document.getElementById('adbutils-range').textContent = `Min: ${adbutils.min_ms}ms | Max: ${adbutils.max_ms}ms`;
                adbUtilsCard.style.borderColor = 'var(--border-color)';
            } else {
                document.getElementById('adbutils-avg').textContent = 'N/A';
                document.getElementById('adbutils-avg').style.color = 'var(--text-secondary)';
                document.getElementById('adbutils-range').textContent = adbutils.error || 'Not available';
                adbUtilsCard.style.borderColor = 'var(--error-color)';
            }

            // adb_bridge results
            const adbBridge = backends.adb_bridge || {};
            const adbBridgeCard = document.getElementById('adb-bridge-card');
            if (adbBridge.available && adbBridge.avg_ms) {
                document.getElementById('adb-bridge-avg').textContent = `${adbBridge.avg_ms.toFixed(0)}ms`;
                document.getElementById('adb-bridge-avg').style.color = getTimeColor(adbBridge.avg_ms);
                document.getElementById('adb-bridge-range').textContent = `Min: ${adbBridge.min_ms}ms | Max: ${adbBridge.max_ms}ms`;
                adbBridgeCard.style.borderColor = 'var(--border-color)';
            } else {
                document.getElementById('adb-bridge-avg').textContent = 'N/A';
                document.getElementById('adb-bridge-avg').style.color = 'var(--text-secondary)';
                document.getElementById('adb-bridge-range').textContent = adbBridge.error || 'Not available';
                adbBridgeCard.style.borderColor = 'var(--error-color)';
            }

            // Recommendation
            const recommended = data.recommended_backend;
            const bestTime = data.best_avg_ms;
            document.getElementById('recommended-backend').textContent = recommended ? recommended.toUpperCase() : 'N/A';
            document.getElementById('best-time').textContent = bestTime ? `${bestTime.toFixed(0)}ms avg` : '--';
        }

        function getTimeColor(ms) {
            if (ms < 300) return '#4caf50';  // Green - great
            if (ms < 800) return '#ff9800';   // Orange - ok
            return '#f44336';                  // Red - slow
        }

        document.getElementById('runBackendBenchmark').onclick = runBackendBenchmark;

        // === System Diagnostics ===
        document.getElementById('testSystem').onclick = async () => {
            const el = document.getElementById('systemResult');
            try {
                el.innerHTML = '<p class="status"><span class="loading-spinner"></span> Checking system...</p>';
                const r = await api.get('/diagnostics/system');

                let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-top:10px;">';

                // CPU Usage
                html += `
                    <div style="background:var(--preview-background);padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:24px;font-weight:bold;color:${r.cpu_percent > 80 ? '#f44336' : '#4caf50'};">${r.cpu_percent.toFixed(1)}%</div>
                        <div style="font-size:12px;color:var(--text-secondary);">CPU Usage</div>
                    </div>
                `;

                // Memory Usage
                const memPercent = (r.memory_used_mb / r.memory_total_mb * 100);
                html += `
                    <div style="background:var(--preview-background);padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:24px;font-weight:bold;color:${memPercent > 80 ? '#f44336' : '#4caf50'};">${memPercent.toFixed(1)}%</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Memory (${r.memory_used_mb}/${r.memory_total_mb} MB)</div>
                    </div>
                `;

                // Connected Devices
                html += `
                    <div style="background:var(--preview-background);padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:24px;font-weight:bold;color:#2196f3;">${r.connected_devices}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Connected Devices</div>
                    </div>
                `;

                // Active Streams
                html += `
                    <div style="background:var(--preview-background);padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:24px;font-weight:bold;color:#9c27b0;">${r.active_streams || 0}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Active Streams</div>
                    </div>
                `;

                // Flow Scheduler Status
                const fs = r.flow_scheduler || {};
                const fsRunning = fs.running && !fs.paused;
                const fsColor = fsRunning ? '#ff9800' : '#4caf50';
                const fsLabel = fsRunning ? 'Running' : (fs.paused ? 'Paused' : 'Stopped');
                html += `
                    <div style="background:var(--preview-background);padding:15px;border-radius:8px;text-align:center;">
                        <div style="font-size:18px;font-weight:bold;color:${fsColor};">${fsLabel}</div>
                        <div style="font-size:12px;color:var(--text-secondary);">Flow Scheduler (${fs.active_flows || 0} flows)</div>
                        ${fsRunning ? '<div style="font-size:11px;color:#ff5722;margin-top:4px;">⚠️ May impact ADB performance</div>' : ''}
                    </div>
                `;

                html += '</div>';

                // Server uptime
                if (r.uptime_seconds) {
                    const hours = Math.floor(r.uptime_seconds / 3600);
                    const mins = Math.floor((r.uptime_seconds % 3600) / 60);
                    html += `<p style="margin-top:10px;color:var(--text-secondary);font-size:13px;">Server uptime: ${hours}h ${mins}m</p>`;
                }

                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = `<p class="status error">System check failed: ${e.message}</p>`;
            }
        };

        // Add extraction step
        function addStep() {
            const stepId = Date.now();
            pipelineSteps.push({
                id: stepId,
                method: 'numeric',
                params: {}
            });
            renderPipeline();
        }

        // Remove extraction step
        window.removeStep = function(stepId) {
            pipelineSteps = pipelineSteps.filter(s => s.id !== stepId);
            renderPipeline();
        };

        // Update step method
        window.updateStepMethod = function(stepId, method) {
            const step = pipelineSteps.find(s => s.id === stepId);
            if (step) {
                step.method = method;
                step.params = {}; // Reset params when method changes
                renderPipeline();
            }
        };

        // Render pipeline UI
        function renderPipeline() {
            const container = document.getElementById('pipelineSteps');

            if (pipelineSteps.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No extraction steps. Add a step to test extraction.</p>';
                return;
            }

            let html = '';
            pipelineSteps.forEach((step, index) => {
                html += `
                    <div class="pipeline-step">
                        <div class="pipeline-step-header">
                            <strong>Step ${index + 1}</strong>
                            <button class="remove-step-btn" onclick="removeStep(${step.id})">Remove</button>
                        </div>
                        <div style="display: grid; gap: 8px;">
                            <div>
                                <label>Method:</label>
                                <select class="form-select" onchange="updateStepMethod(${step.id}, this.value)" id="method_${step.id}">
                                    <option value="exact" ${step.method === 'exact' ? 'selected' : ''}>exact</option>
                                    <option value="numeric" ${step.method === 'numeric' ? 'selected' : ''}>numeric</option>
                                    <option value="regex" ${step.method === 'regex' ? 'selected' : ''}>regex</option>
                                    <option value="after" ${step.method === 'after' ? 'selected' : ''}>after</option>
                                    <option value="before" ${step.method === 'before' ? 'selected' : ''}>before</option>
                                    <option value="between" ${step.method === 'between' ? 'selected' : ''}>between</option>
                                </select>
                            </div>
                            ${renderStepParams(step)}
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Render step-specific parameters
        function renderStepParams(step) {
            switch (step.method) {
                case 'regex':
                    return `
                        <div>
                            <label>Regex Pattern:</label>
                            <input class="form-input" id="param_${step.id}" placeholder="e.g., \\d+" value="${step.params.regex_pattern || ''}">
                        </div>
                    `;
                case 'after':
                    return `
                        <div>
                            <label>After Text:</label>
                            <input class="form-input" id="param_${step.id}" placeholder="Text to search after" value="${step.params.after_text || ''}">
                        </div>
                    `;
                case 'before':
                    return `
                        <div>
                            <label>Before Text:</label>
                            <input class="form-input" id="param_${step.id}" placeholder="Text to search before" value="${step.params.before_text || ''}">
                        </div>
                    `;
                case 'between':
                    return `
                        <div>
                            <label>Between Start:</label>
                            <input class="form-input" id="param_start_${step.id}" placeholder="Start delimiter" value="${step.params.between_start || ''}">
                        </div>
                        <div>
                            <label>Between End:</label>
                            <input class="form-input" id="param_end_${step.id}" placeholder="End delimiter" value="${step.params.between_end || ''}">
                        </div>
                    `;
                default:
                    return '';
            }
        }

        // Build extraction rule from pipeline
        function buildExtractionRule() {
            if (pipelineSteps.length === 0) {
                return null;
            }

            // Read parameters from form inputs
            const pipeline = pipelineSteps.map(step => {
                const rule = { method: step.method };

                if (step.method === 'regex') {
                    const input = document.getElementById(`param_${step.id}`);
                    if (input && input.value) {
                        rule.regex_pattern = input.value;
                    }
                } else if (step.method === 'after') {
                    const input = document.getElementById(`param_${step.id}`);
                    if (input && input.value) {
                        rule.after_text = input.value;
                    }
                } else if (step.method === 'before') {
                    const input = document.getElementById(`param_${step.id}`);
                    if (input && input.value) {
                        rule.before_text = input.value;
                    }
                } else if (step.method === 'between') {
                    const startInput = document.getElementById(`param_start_${step.id}`);
                    const endInput = document.getElementById(`param_end_${step.id}`);
                    if (startInput && startInput.value && endInput && endInput.value) {
                        rule.between_start = startInput.value;
                        rule.between_end = endInput.value;
                    }
                }

                return rule;
            });

            // Build full extraction rule
            const extraction_rule = {
                pipeline: pipeline,
                extract_numeric: document.getElementById('extractNumeric').checked,
                remove_unit: document.getElementById('removeUnit').checked
            };

            const fallback = document.getElementById('fallbackValue').value;
            if (fallback) {
                extraction_rule.fallback_value = fallback;
            }

            return extraction_rule;
        }

        // API Health Check
        document.getElementById('testHealth').onclick = async () => {
            const el = document.getElementById('healthResult');
            try {
                const r = await api.get('/health');
                el.innerHTML = '<p class="status success">✅ Running v' + r.version + '</p>';
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // ADB Connection Test
        document.getElementById('testAdb').onclick = async () => {
            const el = document.getElementById('adbResult');
            try {
                const r = await api.get('/adb/devices');
                el.innerHTML = `<p class="status success">✅ Found ${r.devices.length} device(s)</p><pre>${JSON.stringify(r, null, 2)}</pre>`;
                loadDevs();
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // === ADB Maintenance Handlers ===
        document.getElementById('restartAdbServer').onclick = async () => {
            const el = document.getElementById('serverStatusResult');
            el.innerHTML = '<span class="loading-spinner"></span> Restarting ADB server...';
            try {
                const r = await api.post('/maintenance/server/restart');
                el.innerHTML = `<p class="status success">✅ ${r.message}</p>`;
                setTimeout(loadDevs, 2000); // Reload devices after restart
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('checkServerStatus').onclick = async () => {
            const el = document.getElementById('serverStatusResult');
            try {
                const r = await api.get('/maintenance/server/status');
                el.innerHTML = `<p class="status success">✅ Server running - ${r.device_count} device(s) connected</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('trimCache').onclick = async () => {
            const dev = document.getElementById('maintDev').value;
            const el = document.getElementById('maintResult');
            if (!dev) { el.innerHTML = '<p class="status error">Select device</p>'; return; }
            el.innerHTML = '<span class="loading-spinner"></span> Trimming cache...';
            try {
                const r = await api.post(`/maintenance/${encodeURIComponent(dev)}/trim-cache`);
                el.innerHTML = `<p class="status success">✅ ${r.message}</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('optimizeUi').onclick = async () => {
            const dev = document.getElementById('maintDev').value;
            const el = document.getElementById('maintResult');
            if (!dev) { el.innerHTML = '<p class="status error">Select device</p>'; return; }
            el.innerHTML = '<span class="loading-spinner"></span> Optimizing UI...';
            try {
                const r = await api.post(`/maintenance/${encodeURIComponent(dev)}/optimize-ui`);
                el.innerHTML = `<p class="status success">✅ ${r.optimizations_applied}/${r.total_optimizations} optimizations applied</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('resetUi').onclick = async () => {
            const dev = document.getElementById('maintDev').value;
            const el = document.getElementById('maintResult');
            if (!dev) { el.innerHTML = '<p class="status error">Select device</p>'; return; }
            try {
                const r = await api.post(`/maintenance/${encodeURIComponent(dev)}/reset-ui`);
                el.innerHTML = `<p class="status success">✅ ${r.message}</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('fullOptimize').onclick = async () => {
            const dev = document.getElementById('maintDev').value;
            const el = document.getElementById('maintResult');
            if (!dev) { el.innerHTML = '<p class="status error">Select device</p>'; return; }
            el.innerHTML = '<span class="loading-spinner"></span> Running full optimization...';
            try {
                const r = await api.post(`/maintenance/${encodeURIComponent(dev)}/full-optimize`);
                el.innerHTML = `<p class="status success">✅ ${r.successful}/${r.optimizations_run} optimizations successful</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('getConnMetrics').onclick = async () => {
            const el = document.getElementById('metricsResult');
            try {
                const r = await api.get('/maintenance/metrics');
                if (Object.keys(r.metrics).length === 0) {
                    el.innerHTML = '<p style="color:var(--text-secondary);">No metrics yet. Metrics are collected as commands are run.</p>';
                } else {
                    el.innerHTML = `<pre style="font-size:12px;">${JSON.stringify(r.metrics, null, 2)}</pre>`;
                }
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('compileApps').onclick = async () => {
            const dev = document.getElementById('maintDev').value;
            const mode = document.getElementById('compileMode').value;
            const el = document.getElementById('maintResult');
            if (!dev) { el.innerHTML = '<p class="status error">Select device</p>'; return; }
            el.innerHTML = '<span class="loading-spinner"></span> Starting ART compilation (this takes 5-15 minutes)...';
            try {
                const r = await api.post(`/maintenance/${encodeURIComponent(dev)}/compile-apps?mode=${mode}`);
                el.innerHTML = `<p class="status success">✅ ${r.message} (mode: ${r.mode})</p><p style="color:var(--text-secondary);">${r.note}</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('setBgLimit').onclick = async () => {
            const dev = document.getElementById('maintDev').value;
            const limit = parseInt(document.getElementById('bgLimit').value);
            const el = document.getElementById('maintResult');
            if (!dev) { el.innerHTML = '<p class="status error">Select device</p>'; return; }
            try {
                const r = await api.post(`/maintenance/${encodeURIComponent(dev)}/background-limit?limit=${limit}`);
                el.innerHTML = `<p class="status success">✅ ${r.message}</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('resetDisplay').onclick = async () => {
            const dev = document.getElementById('maintDev').value;
            const el = document.getElementById('maintResult');
            if (!dev) { el.innerHTML = '<p class="status error">Select device</p>'; return; }
            if (!confirm('This will reset display size and density to defaults. Continue?')) return;
            try {
                const r = await api.post(`/maintenance/${encodeURIComponent(dev)}/reset-display`);
                el.innerHTML = `<p class="status success">✅ ${r.message}</p>`;
            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        // === Persistent Shell Pool Handlers ===

        document.getElementById('runShellBenchmark').onclick = async () => {
            const dev = document.getElementById('shellDev').value;
            const iterations = parseInt(document.getElementById('shellIterations').value) || 10;
            const el = document.getElementById('shellBenchmarkResult');

            if (!dev) {
                el.innerHTML = '<p class="status error">Select device</p>';
                return;
            }

            el.innerHTML = '<p><span class="loading-spinner"></span> Running benchmark...</p>';

            try {
                const r = await api.post(`/shell/${encodeURIComponent(dev)}/benchmark?iterations=${iterations}`);
                const b = r.benchmark;

                let html = '<div style="background: var(--preview-background); padding: 15px; border-radius: 8px;">';
                html += '<h4 style="margin: 0 0 15px 0;">Benchmark Results</h4>';

                // Results table
                html += '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
                html += '<tr style="border-bottom: 1px solid var(--border-color);">';
                html += '<th style="text-align: left; padding: 8px;">Method</th>';
                html += '<th style="text-align: right; padding: 8px;">Avg (ms)</th>';
                html += '<th style="text-align: right; padding: 8px;">Min (ms)</th>';
                html += '<th style="text-align: right; padding: 8px;">Max (ms)</th>';
                html += '</tr>';

                // Persistent shell row
                const psTimes = b.persistent_shell.times_ms || [];
                html += '<tr>';
                html += '<td style="padding: 8px;">Persistent Shell</td>';
                html += `<td style="text-align: right; padding: 8px; color: #4caf50; font-weight: bold;">${b.persistent_shell.avg_ms}</td>`;
                html += `<td style="text-align: right; padding: 8px;">${psTimes.length ? Math.min(...psTimes).toFixed(1) : '-'}</td>`;
                html += `<td style="text-align: right; padding: 8px;">${psTimes.length ? Math.max(...psTimes).toFixed(1) : '-'}</td>`;
                html += '</tr>';

                // Regular ADB row
                const regTimes = b.regular_adb.times_ms || [];
                html += '<tr>';
                html += '<td style="padding: 8px;">Regular ADB Shell</td>';
                html += `<td style="text-align: right; padding: 8px;">${b.regular_adb.avg_ms}</td>`;
                html += `<td style="text-align: right; padding: 8px;">${regTimes.length ? Math.min(...regTimes).toFixed(1) : '-'}</td>`;
                html += `<td style="text-align: right; padding: 8px;">${regTimes.length ? Math.max(...regTimes).toFixed(1) : '-'}</td>`;
                html += '</tr>';
                html += '</table>';

                // Improvement summary
                const improvement = b.improvement_percent;
                const improvementColor = improvement > 0 ? '#4caf50' : '#f44336';
                html += `<div style="margin-top: 15px; padding: 10px; background: ${improvementColor}22; border-radius: 4px; border-left: 4px solid ${improvementColor};">`;
                html += `<strong style="color: ${improvementColor};">${improvement > 0 ? '✅' : '⚠️'} ${Math.abs(improvement)}% ${improvement > 0 ? 'faster' : 'slower'}</strong>`;
                html += `<p style="margin: 5px 0 0 0; font-size: 12px; color: var(--text-secondary);">Persistent shells reuse connections, eliminating per-command handshake overhead.</p>`;
                html += '</div>';

                html += '</div>';
                el.innerHTML = html;

            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        document.getElementById('getShellStats').onclick = async () => {
            const el = document.getElementById('shellBenchmarkResult');
            el.innerHTML = '<p><span class="loading-spinner"></span> Loading stats...</p>';

            try {
                const r = await api.get('/shell/stats');
                const stats = r.stats;

                let html = '<div style="background: var(--preview-background); padding: 15px; border-radius: 8px;">';
                html += '<h4 style="margin: 0 0 10px 0;">Shell Pool Statistics</h4>';
                html += `<p style="font-size: 13px;">Total Sessions: ${stats.total_sessions} | Active: ${stats.active_sessions}</p>`;

                if (Object.keys(stats.devices).length > 0) {
                    html += '<div style="margin-top: 10px;">';
                    for (const [deviceId, sessions] of Object.entries(stats.devices)) {
                        html += `<div style="margin-bottom: 10px; padding: 10px; background: var(--card-background); border-radius: 4px;">`;
                        html += `<strong style="font-size: 12px;">${deviceId}</strong>`;
                        sessions.forEach(s => {
                            html += `<div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">`;
                            html += `Session ${s.session_id}: ${s.command_count} cmds, avg ${s.avg_latency_ms}ms, ${s.is_active ? '🟢 active' : '⚫ inactive'}`;
                            html += '</div>';
                        });
                        html += '</div>';
                    }
                    html += '</div>';
                } else {
                    html += '<p style="font-size: 13px; color: var(--text-secondary);">No active sessions. Run a benchmark to create sessions.</p>';
                }

                html += '</div>';
                el.innerHTML = html;

            } catch (e) {
                el.innerHTML = `<p class="status error">❌ ${e.message}</p>`;
            }
        };

        // === Backend Settings Handlers ===

        document.getElementById('loadBackendSettings').onclick = async () => {
            const dev = document.getElementById('backendSettingsDev').value;
            const grid = document.getElementById('backendSettingsGrid');
            const statusEl = document.getElementById('backendSaveStatus');

            if (!dev) {
                statusEl.innerHTML = '<span style="color: #f44336;">Select a device first</span>';
                grid.style.display = 'none';
                return;
            }

            statusEl.innerHTML = '<span class="loading-spinner"></span> Loading...';

            try {
                const r = await api.get(`/settings/backend/${encodeURIComponent(dev)}`);

                // Set current values
                document.getElementById('captureBackendSelect').value = r.capture_backend || 'auto';
                document.getElementById('shellMethodSelect').value = r.shell_method || 'auto';

                grid.style.display = 'block';
                statusEl.innerHTML = '<span style="color: #4caf50;">✓ Loaded</span>';

            } catch (e) {
                statusEl.innerHTML = `<span style="color: #f44336;">❌ ${e.message}</span>`;
                grid.style.display = 'none';
            }
        };

        document.getElementById('saveBackendSettings').onclick = async () => {
            const dev = document.getElementById('backendSettingsDev').value;
            const statusEl = document.getElementById('backendSaveStatus');

            if (!dev) {
                statusEl.innerHTML = '<span style="color: #f44336;">Select a device first</span>';
                return;
            }

            const captureBackend = document.getElementById('captureBackendSelect').value;
            const shellMethod = document.getElementById('shellMethodSelect').value;

            statusEl.innerHTML = '<span class="loading-spinner"></span> Saving...';

            try {
                const r = await api.post(`/settings/backend/${encodeURIComponent(dev)}`, {
                    capture_backend: captureBackend,
                    shell_method: shellMethod
                });

                statusEl.innerHTML = `<span style="color: #4caf50;">✓ Saved: ${r.updated.join(', ')}</span>`;

            } catch (e) {
                statusEl.innerHTML = `<span style="color: #f44336;">❌ ${e.message}</span>`;
            }
        };

        // Auto-load backend settings when device is selected
        document.getElementById('backendSettingsDev').addEventListener('change', () => {
            const dev = document.getElementById('backendSettingsDev').value;
            if (dev) {
                document.getElementById('loadBackendSettings').click();
            } else {
                document.getElementById('backendSettingsGrid').style.display = 'none';
            }
        });

        // Screenshot Test
        document.getElementById('testScr').onclick = async () => {
            const el = document.getElementById('scrResult');
            const dev = document.getElementById('scrDev').value;

            if (!dev) {
                el.innerHTML = '<p class="status error">Select device</p>';
                return;
            }

            try {
                const r = await api.post('/adb/screenshot', { device_id: dev });
                el.innerHTML = `<p class="status success">✅ ${r.size} bytes</p><img src="data:image/png;base64,${r.image}" style="max-width:100%;border:1px solid var(--border-color)">`;
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // Text Extraction Test (with Pipeline)
        document.getElementById('testExt').onclick = async () => {
            const el = document.getElementById('extResult');
            const text = document.getElementById('extText').value;

            if (!text) {
                el.innerHTML = '<p class="status error">Please enter text to test</p>';
                return;
            }

            const extraction_rule = buildExtractionRule();

            if (!extraction_rule) {
                el.innerHTML = '<p class="status error">Please add at least one extraction step</p>';
                return;
            }

            // Validate required parameters
            for (let i = 0; i < pipelineSteps.length; i++) {
                const step = pipelineSteps[i];
                const rule = extraction_rule.pipeline[i];

                if (step.method === 'regex' && !rule.regex_pattern) {
                    el.innerHTML = `<p class="status error">Step ${i + 1}: Please enter regex pattern</p>`;
                    return;
                }
                if (step.method === 'after' && !rule.after_text) {
                    el.innerHTML = `<p class="status error">Step ${i + 1}: Please enter "after" text</p>`;
                    return;
                }
                if (step.method === 'before' && !rule.before_text) {
                    el.innerHTML = `<p class="status error">Step ${i + 1}: Please enter "before" text</p>`;
                    return;
                }
                if (step.method === 'between' && (!rule.between_start || !rule.between_end)) {
                    el.innerHTML = `<p class="status error">Step ${i + 1}: Please enter both start and end delimiters</p>`;
                    return;
                }
            }

            try {
                const r = await api.post('/test/extract', { text, extraction_rule });

                let resultHtml = '<div style="background: var(--preview-background); padding: 15px; border-radius: 6px; border: 2px solid var(--success-color);">';
                resultHtml += `<p style="margin: 0 0 10px 0;"><strong>✅ Extraction Successful!</strong></p>`;
                resultHtml += `<p style="margin: 5px 0;"><strong>Original:</strong> "${text}"</p>`;
                resultHtml += `<p style="margin: 5px 0;"><strong>Pipeline Steps:</strong> ${pipelineSteps.length}</p>`;
                resultHtml += `<p style="margin: 5px 0; font-size: 16px; color: var(--primary-color);"><strong>Result:</strong> "${r.extracted_value}"</p>`;
                resultHtml += '</div>';

                el.innerHTML = resultHtml;
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // Tap Test
        document.getElementById('testTap').onclick = async () => {
            const el = document.getElementById('ctrlResult');
            const dev = document.getElementById('ctrlDev').value;

            if (!dev) {
                el.innerHTML = '<p class="status error">Select device</p>';
                return;
            }

            try {
                await api.post('/adb/tap', { device_id: dev, x: 500, y: 500 });
                el.innerHTML = '<p class="status success">✅ Tap sent to (500,500)</p>';
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // Keyevent Test
        document.getElementById('testKey').onclick = async () => {
            const el = document.getElementById('ctrlResult');
            const dev = document.getElementById('ctrlDev').value;

            if (!dev) {
                el.innerHTML = '<p class="status error">Select device</p>';
                return;
            }

            try {
                await api.post('/adb/keyevent', { device_id: dev, keycode: '3' });
                el.innerHTML = '<p class="status success">✅ HOME key sent</p>';
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // Swipe Test
        document.getElementById('testSwipe').onclick = async () => {
            const el = document.getElementById('ctrlResult');
            const dev = document.getElementById('ctrlDev').value;

            if (!dev) {
                el.innerHTML = '<p class="status error">Select device</p>';
                return;
            }

            try {
                // Swipe down from top (500,300) to (500,1000)
                await api.post('/adb/swipe', {
                    device_id: dev,
                    x1: 500, y1: 300,
                    x2: 500, y2: 1000,
                    duration_ms: 300
                });
                el.innerHTML = '<p class="status success">✅ Swipe down sent</p>';
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // Add step button
        document.getElementById('addStep').onclick = addStep;

        // === Scheduler Tests ===
        document.getElementById('testSchedulerStatus').onclick = async () => {
            const el = document.getElementById('schedulerResult');
            try {
                const r = await api.get('/scheduler/status');
                const status = r.status;
                const statusClass = status.running ? 'success' : 'warning';
                let html = `<p class="status ${statusClass}">`;
                html += status.running ? '✅ Scheduler Running' : '⚠️ Scheduler Not Running';
                html += status.paused ? ' (PAUSED)' : '';
                html += `</p>`;
                html += `<pre style="margin-top:10px;background:var(--preview-background);padding:10px;border-radius:4px;overflow:auto">${JSON.stringify(status, null, 2)}</pre>`;
                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        document.getElementById('testSchedulerPause').onclick = async () => {
            const el = document.getElementById('schedulerResult');
            try {
                const r = await api.post('/scheduler/pause');
                el.innerHTML = '<p class="status success">✅ Scheduler Paused</p>';
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        document.getElementById('testSchedulerResume').onclick = async () => {
            const el = document.getElementById('schedulerResult');
            try {
                const r = await api.post('/scheduler/resume');
                el.innerHTML = '<p class="status success">✅ Scheduler Resumed</p>';
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // === Flow API Tests ===
        document.getElementById('testListFlows').onclick = async () => {
            const el = document.getElementById('flowResult');
            try {
                const r = await api.get('/flows');
                const flows = r.flows || [];
                let html = `<p class="status success">✅ Found ${flows.length} flow(s)</p>`;
                if (flows.length > 0) {
                    html += '<ul style="margin-top:10px;list-style:disc;margin-left:20px">';
                    flows.forEach(f => {
                        html += `<li><strong>${f.name || f.flow_id}</strong> - ${f.enabled ? 'enabled' : 'disabled'}</li>`;
                    });
                    html += '</ul>';
                }
                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        document.getElementById('testFlowQueue').onclick = async () => {
            const el = document.getElementById('flowResult');
            const dev = document.getElementById('flowDev').value;

            if (!dev) {
                el.innerHTML = '<p class="status warning">Select a device first</p>';
                return;
            }

            try {
                const r = await api.get(`/scheduler/queue/${dev}`);
                let html = `<p class="status success">✅ Queue retrieved for ${dev}</p>`;
                html += `<pre style="margin-top:10px;background:var(--preview-background);padding:10px;border-radius:4px;overflow:auto">${JSON.stringify(r, null, 2)}</pre>`;
                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // === MQTT Test ===
        document.getElementById('testMqtt').onclick = async () => {
            const el = document.getElementById('mqttResult');
            try {
                const r = await api.get('/mqtt/status');
                const connected = r.connected;
                const statusClass = connected ? 'success' : 'error';
                let html = `<p class="status ${statusClass}">`;
                html += connected ? '✅ MQTT Connected' : '❌ MQTT Disconnected';
                html += `</p>`;
                html += `<pre style="margin-top:10px;background:var(--preview-background);padding:10px;border-radius:4px;overflow:auto">${JSON.stringify(r, null, 2)}</pre>`;
                el.innerHTML = html;
            } catch (e) {
                el.innerHTML = '<p class="status error">❌ ' + e.message + '</p>';
            }
        };

        // === Real-Time Log Viewer ===
        let logWebSocket = null;
        let logAutoScroll = true;
        let capturedLogs = []; // Store all captured logs for export

        const logLevelColors = {
            'DEBUG': '#888888',
            'INFO': '#4caf50',
            'WARNING': '#ff9800',
            'ERROR': '#f44336',
            'CRITICAL': '#e91e63'
        };

        const logLevelPriority = {
            'DEBUG': 0,
            'INFO': 1,
            'WARNING': 2,
            'ERROR': 3,
            'CRITICAL': 4,
            'all': -1
        };

        function getLogLevelFilter() {
            const selected = document.getElementById('logLevel').value;
            return logLevelPriority[selected] ?? -1;
        }

        function shouldShowLog(logLevel) {
            const filter = getLogLevelFilter();
            if (filter === -1) return true; // "all" shows everything
            const logPriority = logLevelPriority[logLevel] ?? 1;
            return logPriority >= filter;
        }

        function formatLogEntry(log) {
            if (!shouldShowLog(log.level)) return '';

            const color = logLevelColors[log.level] || '#888';
            const levelPad = log.level.padEnd(8);

            // Handle different timestamp formats
            let timestamp;
            if (typeof log.timestamp === 'number') {
                timestamp = new Date(log.timestamp * 1000).toLocaleTimeString();
            } else if (typeof log.timestamp === 'string') {
                timestamp = log.timestamp;
            } else {
                timestamp = new Date().toLocaleTimeString();
            }

            const module = log.module ? `[${log.module}]` : '';

            return `<div style="margin: 2px 0; white-space: pre-wrap; word-break: break-all;">` +
                `<span style="color: #666;">${timestamp}</span> ` +
                `<span style="color: ${color}; font-weight: bold;">${levelPad}</span>` +
                `<span style="color: #888;">${module}</span> ` +
                `<span style="color: #ddd;">${log.message}</span>` +
                `</div>`;
        }

        function appendLog(log) {
            // Store log for export
            capturedLogs.push(log);
            updateLogCount();

            const viewer = document.getElementById('logViewer');
            const html = formatLogEntry(log);
            if (html) {
                viewer.innerHTML += html;
                // Auto-scroll if near bottom
                if (logAutoScroll) {
                    viewer.scrollTop = viewer.scrollHeight;
                }
            }
        }

        function updateLogCount() {
            document.getElementById('logCount').textContent = capturedLogs.length;
        }

        function getSelectedExportLevels() {
            const levels = [];
            if (document.getElementById('expDebug').checked) levels.push('DEBUG');
            if (document.getElementById('expInfo').checked) levels.push('INFO');
            if (document.getElementById('expWarning').checked) levels.push('WARNING');
            if (document.getElementById('expError').checked) levels.push('ERROR', 'CRITICAL');
            return levels;
        }

        function getFilteredLogs() {
            const selectedLevels = getSelectedExportLevels();

            if (selectedLevels.length === 0) {
                return []; // No levels selected
            }

            return capturedLogs.filter(log => selectedLevels.includes(log.level));
        }

        function getExportFilterDescription() {
            const levels = [];
            if (document.getElementById('expDebug').checked) levels.push('DEBUG');
            if (document.getElementById('expInfo').checked) levels.push('INFO');
            if (document.getElementById('expWarning').checked) levels.push('WARN');
            if (document.getElementById('expError').checked) levels.push('ERROR');
            return levels.length > 0 ? levels.join('+') : 'none';
        }

        function formatLogForText(log) {
            const timestamp = typeof log.timestamp === 'number'
                ? new Date(log.timestamp * 1000).toISOString()
                : log.timestamp || new Date().toISOString();
            const module = log.module ? `[${log.module}]` : '';
            return `${timestamp} ${log.level.padEnd(8)} ${module} ${log.message}`;
        }

        function exportLogsAsJson() {
            const logs = getFilteredLogs();
            const filterDesc = getExportFilterDescription();

            if (logs.length === 0) {
                alert('No logs to export. Check your level filters or capture more logs.');
                return;
            }

            const exportData = {
                exported_at: new Date().toISOString(),
                filter: filterDesc,
                total_captured: capturedLogs.length,
                total_exported: logs.length,
                logs: logs
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            downloadBlob(blob, `visual-mapper-logs-${Date.now()}.json`);
        }

        function exportLogsAsTxt() {
            const logs = getFilteredLogs();
            const filterDesc = getExportFilterDescription();

            if (logs.length === 0) {
                alert('No logs to export. Check your level filters or capture more logs.');
                return;
            }

            const header = `Visual Mapper Logs - Exported ${new Date().toISOString()}\nFilter: ${filterDesc}\nExported: ${logs.length} of ${capturedLogs.length} logs\n${'='.repeat(80)}\n\n`;
            const content = header + logs.map(formatLogForText).join('\n');

            const blob = new Blob([content], { type: 'text/plain' });
            downloadBlob(blob, `visual-mapper-logs-${Date.now()}.txt`);
        }

        function copyLogsToClipboard() {
            const logs = getFilteredLogs();

            if (logs.length === 0) {
                alert('No logs to copy. Check your level filters or capture more logs.');
                return;
            }

            const content = logs.map(formatLogForText).join('\n');

            navigator.clipboard.writeText(content).then(() => {
                const btn = document.getElementById('copyLogs');
                const originalText = btn.textContent;
                btn.textContent = 'Copied!';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy logs:', err);
                alert('Failed to copy to clipboard. Try using Export instead.');
            });
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function connectToLogs() {
            const statusEl = document.getElementById('logStatus');
            const connectBtn = document.getElementById('connectLogs');
            const disconnectBtn = document.getElementById('disconnectLogs');
            const viewer = document.getElementById('logViewer');

            // Determine WebSocket URL based on current location
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsHost = window.location.host;

            // Check for ingress path
            const url = window.location.href;
            const ingressMatch = url.match(/\/api\/hassio_ingress\/[^\/]+/);
            const basePath = ingressMatch ? ingressMatch[0] : '';

            const wsUrl = `${wsProtocol}//${wsHost}${basePath}/ws/logs`;

            statusEl.textContent = 'Connecting...';
            statusEl.style.color = '#ff9800';
            viewer.innerHTML = '<div style="color: #ff9800;">Connecting to log stream...</div>';

            try {
                logWebSocket = new WebSocket(wsUrl);

                logWebSocket.onopen = () => {
                    statusEl.textContent = 'Connected';
                    statusEl.style.color = '#4caf50';
                    connectBtn.disabled = true;
                    disconnectBtn.disabled = false;
                    viewer.innerHTML = '<div style="color: #4caf50;">Connected! Waiting for logs...</div>';
                };

                logWebSocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);

                        // Handle message by type
                        if (data.type === 'history' && Array.isArray(data.data)) {
                            viewer.innerHTML = ''; // Clear initial message
                            data.data.forEach(log => appendLog(log));
                            if (data.data.length === 0) {
                                viewer.innerHTML = '<div style="color: #888;">No recent logs. New logs will appear here...</div>';
                            }
                        }
                        // Handle single log entry
                        else if (data.type === 'log' && data.data) {
                            appendLog(data.data);
                        }
                        // Handle ping (respond with pong)
                        else if (data.type === 'ping') {
                            // Server sent ping, no need to respond (keepalive)
                        }
                        else if (data.type === 'pong') {
                            // Response to our ping
                        }
                    } catch (e) {
                        console.error('Failed to parse log message:', e);
                    }
                };

                logWebSocket.onclose = (event) => {
                    statusEl.textContent = 'Disconnected';
                    statusEl.style.color = '#f44336';
                    connectBtn.disabled = false;
                    disconnectBtn.disabled = true;
                    logWebSocket = null;

                    if (event.code !== 1000) {
                        viewer.innerHTML += '<div style="color: #f44336;">Connection closed unexpectedly. Click Connect to retry.</div>';
                    }
                };

                logWebSocket.onerror = (error) => {
                    statusEl.textContent = 'Error';
                    statusEl.style.color = '#f44336';
                    viewer.innerHTML += `<div style="color: #f44336;">WebSocket error. Check console for details.</div>`;
                    console.error('WebSocket error:', error);
                };

            } catch (e) {
                statusEl.textContent = 'Failed';
                statusEl.style.color = '#f44336';
                viewer.innerHTML = `<div style="color: #f44336;">Failed to connect: ${e.message}</div>`;
            }
        }

        function disconnectFromLogs() {
            if (logWebSocket) {
                logWebSocket.close(1000, 'User disconnected');
                logWebSocket = null;
            }
            document.getElementById('logStatus').textContent = 'Disconnected';
            document.getElementById('logStatus').style.color = 'var(--text-secondary)';
            document.getElementById('connectLogs').disabled = false;
            document.getElementById('disconnectLogs').disabled = true;
        }

        function clearLogs() {
            const viewer = document.getElementById('logViewer');
            capturedLogs = []; // Clear stored logs
            updateLogCount();

            if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
                viewer.innerHTML = '<div style="color: #4caf50;">Logs cleared. Waiting for new logs...</div>';
            } else {
                viewer.innerHTML = '<div style="color: #666;">Click "Connect" to start viewing logs...</div>';
            }
        }

        // Log viewer event handlers
        document.getElementById('connectLogs').onclick = connectToLogs;
        document.getElementById('disconnectLogs').onclick = disconnectFromLogs;
        document.getElementById('clearLogs').onclick = clearLogs;
        document.getElementById('copyLogs').onclick = copyLogsToClipboard;
        document.getElementById('exportLogsJson').onclick = exportLogsAsJson;
        document.getElementById('exportLogsTxt').onclick = exportLogsAsTxt;

        // Re-filter logs when level changes (clear and reconnect for simplicity)
        document.getElementById('logLevel').onchange = () => {
            if (logWebSocket && logWebSocket.readyState === WebSocket.OPEN) {
                // Reconnect to get filtered history
                disconnectFromLogs();
                setTimeout(connectToLogs, 100);
            }
        };

        // Track scroll position for auto-scroll
        document.getElementById('logViewer').onscroll = function() {
            const viewer = this;
            const nearBottom = viewer.scrollHeight - viewer.scrollTop - viewer.clientHeight < 50;
            logAutoScroll = nearBottom;
        };

        // Initial setup
        loadDevs();
        addStep(); // Add first step by default

        // Also populate flowDev dropdown
        async function loadFlowDevs() {
            try {
                const r = await api.get('/adb/devices');
                const s = document.getElementById('flowDev');
                s.innerHTML = '<option value="">Select device...</option>';
                r.devices.forEach(d => {
                    s.innerHTML += `<option value="${d.id}">${d.id}</option>`;
                });
            } catch (e) {
                console.error('[Diagnostic] Failed to load devices for flow:', e);
            }
        }
        loadFlowDevs();
    </script>
</body>
</html>
